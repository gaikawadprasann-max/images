<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-opacity: 0.45;
    --icon-size: 56px;
    --searchbar-width: 560px;
    --theme: dark;
    --accent: rgba(255,255,255,0.12);
    --text: rgba(255,255,255,0.92);
    --text-sub: rgba(255,255,255,0.55);
    --glass: rgba(255,255,255,0.08);
    --glass-border: rgba(255,255,255,0.15);
    --shadow: 0 8px 32px rgba(0,0,0,0.35);
    --bar-top: auto;
    --bar-bottom: 36px;
    --bar-flex: column;
  }

  body.light-theme {
    --accent: rgba(0,0,0,0.08);
    --text: rgba(20,20,20,0.92);
    --text-sub: rgba(20,20,20,0.5);
    --glass: rgba(255,255,255,0.55);
    --glass-border: rgba(0,0,0,0.12);
    --shadow: 0 8px 32px rgba(0,0,0,0.18);
  }

  html, body {
    width: 100%; height: 100%;
    font-family: 'Outfit', sans-serif;
    overflow: hidden;
    cursor: default;
  }

  #bg {
    position: fixed; inset: 0; z-index: 0;
    background: #0a0a0f url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80') center/cover no-repeat;
    transition: opacity 0.4s;
  }
  #bg::after {
    content: '';
    position: absolute; inset: 0;
    background: rgba(0,0,0,var(--bg-opacity));
    transition: background 0.4s;
  }

  body.light-theme #bg::after {
    background: rgba(255,255,255,calc(var(--bg-opacity) * 0.7));
  }

  #app {
    position: relative; z-index: 1;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* ===== BOTTOM BAR ===== */
  #bottom-bar {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: var(--bar-bottom);
    top: var(--bar-top);
    display: flex;
    flex-direction: var(--bar-flex);
    align-items: center;
    gap: 18px;
    z-index: 10;
    transition: top 0.4s, bottom 0.4s;
  }

  /* ===== TIME ===== */
  #time-block {
    text-align: center;
    user-select: none;
    order: 0;
  }
  #time-display {
    font-family: 'Space Mono', monospace;
    font-size: 2.6rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.04em;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5);
    line-height: 1;
  }
  #date-display {
    font-size: 0.82rem;
    color: var(--text-sub);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* ===== SEARCH BAR ===== */
  #search-wrap {
    width: var(--searchbar-width);
    order: 1;
  }
  #search-form {
    display: flex;
    align-items: center;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 50px;
    padding: 10px 20px;
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow);
    transition: background 0.3s, box-shadow 0.3s;
  }
  #search-form:focus-within {
    background: rgba(255,255,255,0.14);
    box-shadow: 0 8px 40px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.22);
  }
  body.light-theme #search-form:focus-within {
    background: rgba(255,255,255,0.8);
  }
  #search-icon {
    color: var(--text-sub);
    margin-right: 12px;
    flex-shrink: 0;
  }
  #search-input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    font-family: 'Outfit', sans-serif;
    font-size: 1rem;
    color: var(--text);
    caret-color: var(--text);
  }
  #search-input::placeholder { color: var(--text-sub); }

  /* ===== SHORTCUTS ===== */
  #shortcuts-wrap {
    order: 2;
    display: flex;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 700px;
  }

  .shortcut {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(.34,1.56,.64,1);
    text-decoration: none;
    user-select: none;
  }
  .shortcut:hover { transform: translateY(-4px) scale(1.08); }
  .shortcut:active { transform: scale(0.95); }

  .shortcut-icon {
    width: var(--icon-size);
    height: var(--icon-size);
    border-radius: calc(var(--icon-size) * 0.22);
    background: var(--glass);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(16px);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    transition: background 0.2s;
  }
  .shortcut:hover .shortcut-icon {
    background: rgba(255,255,255,0.18);
    border-color: rgba(255,255,255,0.3);
  }
  .shortcut-icon img {
    width: 72%; height: 72%;
    object-fit: contain;
    border-radius: 6px;
  }
  .shortcut-label {
    font-size: 0.7rem;
    color: var(--text-sub);
    letter-spacing: 0.03em;
    max-width: 64px;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Add shortcut button */
  #add-shortcut-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
    background: none;
    border: none;
    transition: transform 0.2s cubic-bezier(.34,1.56,.64,1);
  }
  #add-shortcut-btn:hover { transform: translateY(-4px) scale(1.08); }
  .add-icon-circle {
    width: var(--icon-size);
    height: var(--icon-size);
    border-radius: calc(var(--icon-size) * 0.22);
    background: var(--glass);
    border: 1.5px dashed var(--glass-border);
    backdrop-filter: blur(16px);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-sub);
    font-size: 1.6rem;
    font-weight: 300;
    transition: background 0.2s, border-color 0.2s;
  }
  #add-shortcut-btn:hover .add-icon-circle {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.3);
    color: var(--text);
  }

  /* Settings button */
  #settings-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 100;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(16px);
    border-radius: 50%;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text-sub);
    transition: color 0.2s, background 0.2s, transform 0.4s;
    box-shadow: var(--shadow);
  }
  #settings-btn:hover { color: var(--text); background: rgba(255,255,255,0.15); transform: rotate(90deg); }

  /* ===== MODAL BASE ===== */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: rgba(18,18,24,0.96);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px;
    padding: 28px 30px;
    width: 380px;
    max-width: 95vw;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    color: var(--text);
  }
  body.light-theme .modal {
    background: rgba(245,245,250,0.97);
    border-color: rgba(0,0,0,0.1);
    color: #111;
  }
  .modal h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    letter-spacing: 0.02em;
  }
  .modal-close {
    float: right;
    background: none; border: none;
    color: var(--text-sub);
    font-size: 1.3rem;
    cursor: pointer;
    line-height: 1;
    margin-top: -2px;
  }
  .modal-close:hover { color: var(--text); }

  .field-group { margin-bottom: 16px; }
  .field-group label {
    display: block;
    font-size: 0.78rem;
    color: var(--text-sub);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .field-group input[type="text"],
  .field-group input[type="url"],
  .field-group input[type="range"],
  .field-group select {
    width: 100%;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px;
    padding: 9px 12px;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  body.light-theme .field-group input[type="text"],
  body.light-theme .field-group input[type="url"],
  body.light-theme .field-group select {
    background: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.15);
    color: #111;
  }
  .field-group input:focus, .field-group select:focus { border-color: rgba(255,255,255,0.3); }
  .field-group input[type="range"] { padding: 6px 0; background: none; border: none; cursor: pointer; }

  .range-row { display: flex; align-items: center; gap: 10px; }
  .range-row span { font-size: 0.8rem; min-width: 32px; text-align: right; color: var(--text-sub); }

  .btn-row { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
  .btn {
    padding: 9px 20px;
    border-radius: 10px;
    border: none;
    font-family: 'Outfit', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.85; }
  .btn-primary { background: rgba(255,255,255,0.92); color: #111; font-weight: 600; }
  .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }

  /* Settings modal tabs */
  .settings-modal { width: 430px; }
  .stabs {
    display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap;
  }
  .stab {
    padding: 5px 13px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.12);
    background: none;
    color: var(--text-sub);
    font-family: 'Outfit', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .stab.active {
    background: rgba(255,255,255,0.14);
    color: var(--text);
    border-color: rgba(255,255,255,0.25);
  }
  .stab-content { display: none; }
  .stab-content.active { display: block; }

  .toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px;
  }
  .toggle-label { font-size: 0.88rem; }
  .toggle-sub { font-size: 0.75rem; color: var(--text-sub); }
  .toggle {
    position: relative;
    width: 40px; height: 22px;
    flex-shrink: 0;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.15);
    border-radius: 22px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 16px; height: 16px;
    left: 3px; top: 3px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle input:checked + .toggle-slider { background: rgba(100,180,255,0.7); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(18px); }

  /* Theme toggle buttons */
  .theme-btns { display: flex; gap: 8px; }
  .theme-btn {
    flex: 1; padding: 8px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: none;
    color: var(--text-sub);
    font-family: 'Outfit', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .theme-btn.active { background: rgba(255,255,255,0.14); color: var(--text); border-color: rgba(255,255,255,0.3); }

  /* Shortcut delete */
  .shortcut { position: relative; }
  .shortcut .del-btn {
    position: absolute;
    top: -5px; right: -5px;
    width: 18px; height: 18px;
    background: rgba(255,80,80,0.9);
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .edit-mode .shortcut .del-btn { display: flex; }
  .edit-mode .shortcut { animation: wiggle 0.4s infinite alternate; }
  @keyframes wiggle { from { transform: rotate(-1.5deg); } to { transform: rotate(1.5deg); } }
  .edit-mode .shortcut:hover { transform: none; }

  /* Position select */
  .pos-btns { display: flex; gap: 8px; }
  .pos-btn {
    flex: 1; padding: 7px 4px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: none;
    color: var(--text-sub);
    font-family: 'Outfit', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .pos-btn.active { background: rgba(255,255,255,0.14); color: var(--text); border-color: rgba(255,255,255,0.3); }

  /* Shortcut list in settings */
  #shortcut-list .sc-row {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  #shortcut-list .sc-row img { width: 28px; height: 28px; border-radius: 6px; }
  #shortcut-list .sc-name { flex: 1; font-size: 0.88rem; }
  #shortcut-list .sc-del {
    background: none; border: none;
    color: rgba(255,100,100,0.7); cursor: pointer;
    font-size: 0.8rem; padding: 2px 6px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  #shortcut-list .sc-del:hover { background: rgba(255,80,80,0.15); color: rgba(255,100,100,1); }

  .upload-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 9px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.07);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 0.88rem;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    width: 100%;
  }
  .upload-btn:hover { background: rgba(255,255,255,0.13); border-color: rgba(255,255,255,0.28); }
  body.light-theme .upload-btn {
    background: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.15);
    color: #111;
  }
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
</style>
</head>
<body>

<div id="bg"></div>

<div id="app">
  <!-- Clock shown in center if position is "center" -->
  <div id="center-time" style="display:none; text-align:center; user-select:none;">
    <div id="center-time-display" style="font-family:'Space Mono',monospace;font-size:3.5rem;font-weight:700;color:var(--text);letter-spacing:0.04em;text-shadow:0 2px 20px rgba(0,0,0,0.5);"></div>
    <div id="center-date-display" style="font-size:0.85rem;color:var(--text-sub);letter-spacing:0.12em;text-transform:uppercase;margin-top:6px;"></div>
  </div>
</div>

<!-- Bottom / Top Bar -->
<div id="bottom-bar">
  <div id="time-block">
    <div id="time-display"></div>
    <div id="date-display"></div>
  </div>
  <div id="search-wrap">
    <form id="search-form" onsubmit="doSearch(event)">
      <span id="search-icon">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </span>
      <input id="search-input" type="text" placeholder="Search with Google or enter address" autocomplete="off" spellcheck="false">
    </form>
  </div>
  <div id="shortcuts-wrap">
    <!-- shortcuts injected here -->
    <button id="add-shortcut-btn" title="Add shortcut" onclick="openAddShortcut()">
      <div class="add-icon-circle">+</div>
      <span class="shortcut-label" style="color:var(--text-sub)">Add</span>
    </button>
  </div>
</div>

<!-- Settings button -->
<button id="settings-btn" onclick="openSettings()" title="Settings">
  <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
  </svg>
</button>

<!-- ADD SHORTCUT MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <h2><button class="modal-close" onclick="closeModal('add-modal')">&#215;</button>Add Shortcut</h2>
    <div class="field-group">
      <label>Name</label>
      <input type="text" id="sc-name" placeholder="YouTube">
    </div>
    <div class="field-group">
      <label>URL</label>
      <input type="url" id="sc-url" placeholder="https://youtube.com">
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('add-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addShortcut()">Add</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal settings-modal">
    <h2><button class="modal-close" onclick="closeModal('settings-modal')">&#215;</button>Settings</h2>
    <div class="stabs">
      <button class="stab active" onclick="switchTab('appearance')">Appearance</button>
      <button class="stab" onclick="switchTab('layout')">Layout</button>
      <button class="stab" onclick="switchTab('shortcuts')">Shortcuts</button>
      <button class="stab" onclick="switchTab('background')">Background</button>
    </div>

    <!-- APPEARANCE -->
    <div class="stab-content active" id="tab-appearance">
      <div class="field-group">
        <label>Theme</label>
        <div class="theme-btns">
          <button class="theme-btn active" id="theme-dark-btn" onclick="setTheme('dark')">Dark</button>
          <button class="theme-btn" id="theme-light-btn" onclick="setTheme('light')">Light</button>
        </div>
      </div>
      <div class="field-group">
        <label>Icon Size</label>
        <div class="range-row">
          <input type="range" id="icon-size-range" min="36" max="80" value="56" oninput="updateIconSize(this.value)">
          <span id="icon-size-val">56px</span>
        </div>
      </div>
      <div class="field-group">
        <label>Search Bar Width</label>
        <div class="range-row">
          <input type="range" id="sb-width-range" min="300" max="800" value="560" oninput="updateSearchWidth(this.value)">
          <span id="sb-width-val">560px</span>
        </div>
      </div>
    </div>

    <!-- LAYOUT -->
    <div class="stab-content" id="tab-layout">
      <div class="field-group">
        <label>Bar Position</label>
        <div class="pos-btns">
          <button class="pos-btn active" id="pos-bottom-btn" onclick="setPosition('bottom')">Bottom</button>
          <button class="pos-btn" id="pos-top-btn" onclick="setPosition('top')">Top</button>
        </div>
      </div>
      <div class="field-group">
        <label>Order: Time / Search / Shortcuts</label>
        <select id="order-select" onchange="applyOrder(this.value)">
          <option value="time-search-icons">Time → Search → Shortcuts</option>
          <option value="search-time-icons">Search → Time → Shortcuts</option>
          <option value="icons-search-time">Shortcuts → Search → Time</option>
          <option value="time-icons-search">Time → Shortcuts → Search</option>
        </select>
      </div>
    </div>

    <!-- SHORTCUTS -->
    <div class="stab-content" id="tab-shortcuts">
      <div id="shortcut-list" style="max-height:220px;overflow-y:auto;margin-bottom:12px;"></div>
      <button class="btn btn-primary" style="width:100%" onclick="closeModal('settings-modal'); openAddShortcut()">+ Add New Shortcut</button>
    </div>

    <!-- BACKGROUND -->
    <div class="stab-content" id="tab-background">
      <div class="field-group">
        <label>Upload from Device</label>
        <label class="upload-btn" for="bg-file-input">
          <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Choose Image from Device
        </label>
        <input type="file" id="bg-file-input" accept="image/*" style="display:none" onchange="applyDeviceBg(event)">
      </div>
      <div class="field-group">
        <label>Custom Image URL</label>
        <input type="url" id="bg-url-input" placeholder="https://...">
      </div>
      <div class="btn-row" style="margin-top:8px;margin-bottom:16px;justify-content:flex-start;">
        <button class="btn btn-primary" onclick="applyBgUrl()">Apply</button>
        <button class="btn btn-secondary" onclick="resetBg()">Reset Default</button>
      </div>
      <div class="field-group">
        <label>Background Overlay Opacity</label>
        <div class="range-row">
          <input type="range" id="opacity-range" min="0" max="0.85" step="0.01" value="0.45" oninput="updateOpacity(this.value)">
          <span id="opacity-val">45%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
let state = {
  shortcuts: [
    { name: 'YouTube', url: 'https://youtube.com', favicon: 'https://www.youtube.com/favicon.ico' },
    { name: 'WhatsApp', url: 'https://web.whatsapp.com', favicon: 'https://web.whatsapp.com/favicon.ico' },
    { name: 'LinkedIn', url: 'https://linkedin.com', favicon: 'https://linkedin.com/favicon.ico' },
    { name: 'ChatGPT', url: 'https://chat.openai.com', favicon: 'https://chat.openai.com/favicon.ico' },
    { name: 'Instagram', url: 'https://instagram.com', favicon: 'https://instagram.com/favicon.ico' },
  ],
  theme: 'dark',
  iconSize: 56,
  searchWidth: 560,
  bgUrl: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80',
  bgOpacity: 0.45,
  position: 'bottom',
  order: 'time-search-icons',
};

function loadState() {
  try {
    const s = localStorage.getItem('hpState');
    if (s) Object.assign(state, JSON.parse(s));
  } catch(e) {}
}
function saveState() {
  try { localStorage.setItem('hpState', JSON.stringify(state)); } catch(e) {}
}

// ===== CLOCK =====
function updateClock() {
  const now = new Date();
  let h = now.getHours(), m = now.getMinutes();
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  const time = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ampm}`;
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
  document.getElementById('time-display').textContent = time;
  document.getElementById('date-display').textContent = date;
  document.getElementById('center-time-display').textContent = time;
  document.getElementById('center-date-display').textContent = date;
}
setInterval(updateClock, 1000);
updateClock();

// ===== SEARCH =====
function doSearch(e) {
  e.preventDefault();
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  const url = q.startsWith('http') || q.includes('.') && !q.includes(' ')
    ? (q.startsWith('http') ? q : 'https://'+q)
    : `https://www.google.com/search?q=${encodeURIComponent(q)}`;
  window.location.href = url;
}

// ===== RENDER SHORTCUTS =====
// Priority: clearbit logo API (high quality) → google favicon API (fallback) → letter fallback
function getBestFavicon(url) {
  try {
    const u = new URL(url.startsWith('http') ? url : 'https://'+url);
    // Clearbit gives full-color high-res logos
    return `https://logo.clearbit.com/${u.hostname}`;
  } catch(e) { return ''; }
}
function getGoogleFavicon(url) {
  try {
    const u = new URL(url.startsWith('http') ? url : 'https://'+url);
    return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=128`;
  } catch(e) { return ''; }
}
function getFavicon(url) { return getBestFavicon(url); }

function renderShortcuts() {
  const wrap = document.getElementById('shortcuts-wrap');
  const addBtn = document.getElementById('add-shortcut-btn');
  // Remove old shortcuts
  wrap.querySelectorAll('.shortcut').forEach(el => el.remove());

  state.shortcuts.forEach((sc, i) => {
    const a = document.createElement('a');
    a.className = 'shortcut';
    a.href = sc.url;
    a.title = sc.name;
    const primaryIcon = getBestFavicon(sc.url);
    const fallbackIcon = getGoogleFavicon(sc.url);
    const letterFallback = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='10' fill='rgba(255,255,255,0.18)'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='22' font-weight='bold' fill='white' font-family='sans-serif'>${encodeURIComponent(sc.name[0].toUpperCase())}</text></svg>`;
    const img = document.createElement('img');
    img.src = primaryIcon;
    img.alt = sc.name;
    // fallback chain: clearbit → google → letter
    img.onerror = function() {
      if (this.src !== fallbackIcon) { this.src = fallbackIcon; }
      else { this.src = letterFallback; this.onerror = null; }
    };
    const iconDiv = document.createElement('div');
    iconDiv.className = 'shortcut-icon';
    iconDiv.appendChild(img);
    const label = document.createElement('span');
    label.className = 'shortcut-label';
    label.textContent = sc.name;
    const delBtn = document.createElement('button');
    delBtn.className = 'del-btn';
    delBtn.innerHTML = '&#215;';
    delBtn.onclick = (e) => deleteShortcut(e, i);
    a.appendChild(iconDiv);
    a.appendChild(label);
    a.appendChild(delBtn);
    wrap.insertBefore(a, addBtn);
  });

  renderShortcutList();
}

function renderShortcutList() {
  const list = document.getElementById('shortcut-list');
  if (!list) return;
  list.innerHTML = '';
  if (state.shortcuts.length === 0) {
    list.innerHTML = '<p style="color:var(--text-sub);font-size:0.85rem;text-align:center;padding:20px">No shortcuts yet</p>';
    return;
  }
  state.shortcuts.forEach((sc, i) => {
    const row = document.createElement('div');
    row.className = 'sc-row';
    const img = document.createElement('img');
    img.src = getBestFavicon(sc.url);
    const fb = getGoogleFavicon(sc.url);
    img.onerror = function() { if(this.src !== fb) this.src = fb; else this.style.display='none'; };
    const nameSpan = document.createElement('span');
    nameSpan.className = 'sc-name';
    nameSpan.textContent = sc.name;
    const delBtn = document.createElement('button');
    delBtn.className = 'sc-del';
    delBtn.textContent = 'Remove';
    delBtn.onclick = () => deleteShortcut2(i);
    row.appendChild(img); row.appendChild(nameSpan); row.appendChild(delBtn);
    list.appendChild(row);
  });
}

function deleteShortcut(e, i) {
  e.preventDefault();
  e.stopPropagation();
  state.shortcuts.splice(i, 1);
  saveState();
  renderShortcuts();
}
function deleteShortcut2(i) {
  state.shortcuts.splice(i, 1);
  saveState();
  renderShortcuts();
}

// ===== ADD SHORTCUT =====
function openAddShortcut() {
  document.getElementById('sc-name').value = '';
  document.getElementById('sc-url').value = '';
  openModal('add-modal');
}
function addShortcut() {
  const name = document.getElementById('sc-name').value.trim();
  let url = document.getElementById('sc-url').value.trim();
  if (!name || !url) return;
  if (!url.startsWith('http')) url = 'https://' + url;
  state.shortcuts.push({ name, url });
  saveState();
  renderShortcuts();
  closeModal('add-modal');
}

// ===== DEVICE BG UPLOAD =====
function applyDeviceBg(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    state.bgUrl = dataUrl;
    state.bgIsLocal = true;
    document.getElementById('bg').style.backgroundImage = `url('${dataUrl}')`;
    saveState();
  };
  reader.readAsDataURL(file);
}

// ===== MODALS =====
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function openSettings() { 
  syncSettingsUI();
  openModal('settings-modal'); 
}

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// ===== SETTINGS TABS =====
function switchTab(name) {
  document.querySelectorAll('.stab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.stab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  event.target.classList.add('active');
}

// ===== THEME =====
function setTheme(t) {
  state.theme = t;
  document.body.classList.toggle('light-theme', t === 'light');
  document.getElementById('theme-dark-btn').classList.toggle('active', t === 'dark');
  document.getElementById('theme-light-btn').classList.toggle('active', t === 'light');
  saveState();
}

// ===== ICON SIZE =====
function updateIconSize(v) {
  state.iconSize = parseInt(v);
  document.documentElement.style.setProperty('--icon-size', v+'px');
  document.getElementById('icon-size-val').textContent = v+'px';
  saveState();
}

// ===== SEARCH WIDTH =====
function updateSearchWidth(v) {
  state.searchWidth = parseInt(v);
  document.documentElement.style.setProperty('--searchbar-width', v+'px');
  document.getElementById('sb-width-val').textContent = v+'px';
  saveState();
}

// ===== BACKGROUND =====
function applyBgUrl() {
  const url = document.getElementById('bg-url-input').value.trim();
  if (!url) return;
  state.bgUrl = url;
  document.getElementById('bg').style.backgroundImage = `url('${url}')`;
  saveState();
}
function resetBg() {
  state.bgUrl = 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80';
  state.bgIsLocal = false;
  document.getElementById('bg').style.backgroundImage = `url('${state.bgUrl}')`;
  document.getElementById('bg-url-input').value = '';
  document.getElementById('bg-file-input').value = '';
  saveState();
}
function updateOpacity(v) {
  state.bgOpacity = parseFloat(v);
  document.documentElement.style.setProperty('--bg-opacity', v);
  document.getElementById('opacity-val').textContent = Math.round(v*100)+'%';
  saveState();
}

// ===== POSITION =====
function setPosition(pos) {
  state.position = pos;
  const bar = document.getElementById('bottom-bar');
  if (pos === 'top') {
    document.documentElement.style.setProperty('--bar-top', '28px');
    document.documentElement.style.setProperty('--bar-bottom', 'auto');
    bar.style.top = '28px';
    bar.style.bottom = 'auto';
  } else {
    document.documentElement.style.setProperty('--bar-top', 'auto');
    document.documentElement.style.setProperty('--bar-bottom', '36px');
    bar.style.top = 'auto';
    bar.style.bottom = '36px';
  }
  document.getElementById('pos-bottom-btn').classList.toggle('active', pos === 'bottom');
  document.getElementById('pos-top-btn').classList.toggle('active', pos === 'top');
  saveState();
}

// ===== ORDER =====
function applyOrder(val) {
  state.order = val;
  const map = { 'time-search-icons': [0,1,2], 'search-time-icons': [1,0,2], 'icons-search-time': [2,1,0], 'time-icons-search': [0,2,1] };
  const orders = map[val] || [0,1,2];
  document.getElementById('time-block').style.order = orders[0];
  document.getElementById('search-wrap').style.order = orders[1];
  document.getElementById('shortcuts-wrap').style.order = orders[2];
  saveState();
}

// ===== SYNC SETTINGS UI =====
function syncSettingsUI() {
  document.getElementById('icon-size-range').value = state.iconSize;
  document.getElementById('icon-size-val').textContent = state.iconSize+'px';
  document.getElementById('sb-width-range').value = state.searchWidth;
  document.getElementById('sb-width-val').textContent = state.searchWidth+'px';
  document.getElementById('opacity-range').value = state.bgOpacity;
  document.getElementById('opacity-val').textContent = Math.round(state.bgOpacity*100)+'%';
  document.getElementById('bg-url-input').value = (!state.bgIsLocal && state.bgUrl !== 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80') ? state.bgUrl : '';
  document.getElementById('order-select').value = state.order;
  renderShortcutList();
}

// ===== APPLY SAVED STATE =====
function applyState() {
  if (state.theme === 'light') document.body.classList.add('light-theme');
  document.documentElement.style.setProperty('--icon-size', state.iconSize+'px');
  document.documentElement.style.setProperty('--searchbar-width', state.searchWidth+'px');
  document.documentElement.style.setProperty('--bg-opacity', state.bgOpacity);
  document.getElementById('bg').style.backgroundImage = `url('${state.bgUrl}')`;
  setPosition(state.position);
  applyOrder(state.order);
  // Theme buttons
  document.getElementById('theme-dark-btn').classList.toggle('active', state.theme === 'dark');
  document.getElementById('theme-light-btn').classList.toggle('active', state.theme === 'light');
}

// ===== INIT =====
loadState();
applyState();
renderShortcuts();
</script>
</body>
</html>
